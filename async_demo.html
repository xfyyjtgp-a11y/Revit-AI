<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C# Async/Await å¯è§†åŒ–æ¼”ç¤º</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); max-width: 800px; width: 100%; }
        h1 { color: #333; text-align: center; }
        .scenario { margin-bottom: 30px; border: 1px solid #eee; padding: 20px; border-radius: 8px; }
        .thread-track { display: flex; align-items: center; margin: 10px 0; height: 60px; background: #fafafa; border-radius: 30px; position: relative; overflow: hidden; border: 1px solid #ddd; }
        .thread-label { width: 100px; font-weight: bold; padding-left: 15px; z-index: 2; }
        .worker { width: 40px; height: 40px; border-radius: 50%; background: #0078d4; color: white; display: flex; align-items: center; justify-content: center; position: absolute; left: 120px; transition: left 0.5s linear; z-index: 1; font-size: 20px; }
        .task-block { height: 40px; background: #ffaa00; position: absolute; top: 10px; border-radius: 4px; opacity: 0.7; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; }
        .btn { background: #0078d4; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 5px; }
        .btn:hover { background: #005a9e; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .log { background: #1e1e1e; color: #00ff00; font-family: 'Consolas', monospace; padding: 15px; border-radius: 5px; height: 200px; overflow-y: auto; margin-top: 20px; font-size: 14px; }
        .code-block { background: #f4f4f4; padding: 10px; border-left: 4px solid #0078d4; font-family: monospace; margin: 10px 0; }
        .wait-indicator { position: absolute; color: #666; font-style: italic; font-size: 12px; top: 45px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Async/Await åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</h1>
        
        <div class="scenario">
            <h3>åœºæ™¯ï¼šå»é¤å…ç‚¹é¤ (UI çº¿ç¨‹)</h3>
            <div class="code-block">
                async Task OrderFood() {<br>
                &nbsp;&nbsp;Log("ç‚¹é¤...");<br>
                &nbsp;&nbsp;await CookFoodAsync(); // è€—æ—¶æ“ä½œ<br>
                &nbsp;&nbsp;Log("å–é¤ï¼Œå¼€åƒï¼");<br>
                }
            </div>

            <div class="thread-track">
                <div class="thread-label">UI çº¿ç¨‹</div>
                <div id="worker-ui" class="worker">ğŸ‘¨â€ğŸ’¼</div>
                <!-- Task blocks will be added here dynamically -->
            </div>
            
            <div class="thread-track">
                <div class="thread-label">å¨æˆ¿/IO</div>
                <!-- IO operations happen here -->
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button id="btn-sync" class="btn">åŒæ­¥æ–¹å¼ (å¡æ­»)</button>
                <button id="btn-async" class="btn">Async/Await (æµç•…)</button>
            </div>
        </div>

        <div class="log" id="log-console">
            > ç³»ç»Ÿå°±ç»ª...<br>
        </div>
    </div>

    <script>
        const workerUI = document.getElementById('worker-ui');
        const logConsole = document.getElementById('log-console');
        let isRunning = false;

        function log(msg) {
            const time = new Date().toLocaleTimeString();
            logConsole.innerHTML += `[${time}] ${msg}<br>`;
            logConsole.scrollTop = logConsole.scrollHeight;
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function moveWorker(worker, start, end, duration) {
            const startTime = performance.now();
            
            return new Promise(resolve => {
                function animate(currentTime) {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    const currentPos = start + (end - start) * progress;
                    worker.style.left = `${currentPos}px`;

                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        resolve();
                    }
                }
                requestAnimationFrame(animate);
            });
        }

        // æ¨¡æ‹ŸåŒæ­¥é˜»å¡
        document.getElementById('btn-sync').addEventListener('click', async () => {
            if (isRunning) return;
            isRunning = true;
            log("--- å¼€å§‹åŒæ­¥ç‚¹é¤ (Thread.Sleep) ---");
            
            workerUI.style.backgroundColor = "#d13438"; // å˜çº¢è¡¨ç¤ºé˜»å¡
            workerUI.innerText = "ğŸ˜«";
            
            // 1. ç‚¹é¤
            log("ğŸ‘¨â€ğŸ’¼ UI çº¿ç¨‹: å¼€å§‹ç‚¹é¤");
            await moveWorker(workerUI, 120, 200, 500);
            
            // 2. ç­‰å¾… (å¡æ­»)
            log("ğŸš« UI çº¿ç¨‹: ç­‰å¾…å¨å¸ˆåšé¥­... (ç•Œé¢å¡æ­»ï¼Œæ— æ³•å“åº”é¼ æ ‡)");
            // åœ¨çœŸå®ä»£ç ä¸­è¿™é‡Œæ˜¯ Thread.Sleep(2000)ï¼ŒJSé‡Œæˆ‘ä»¬ç”¨åŠ¨ç”»æ¨¡æ‹Ÿâ€œå¡ä½ä¸åŠ¨â€
            await sleep(2000); 
            
            // 3. å–é¤
            log("ğŸ‘¨â€ğŸ’¼ UI çº¿ç¨‹: é¥­å¥½äº†ï¼Œå–é¤");
            await moveWorker(workerUI, 200, 300, 500);
            
            workerUI.style.backgroundColor = "#0078d4";
            workerUI.innerText = "ğŸ‘¨â€ğŸ’¼";
            workerUI.style.left = "120px"; // Reset
            log("--- ç»“æŸ ---");
            isRunning = false;
        });

        // æ¨¡æ‹Ÿ Async/Await
        document.getElementById('btn-async').addEventListener('click', async () => {
            if (isRunning) return;
            isRunning = true;
            log("--- å¼€å§‹å¼‚æ­¥ç‚¹é¤ (await) ---");
            
            workerUI.style.backgroundColor = "#0078d4";
            workerUI.innerText = "ğŸ‘¨â€ğŸ’¼";

            // 1. ç‚¹é¤
            log("ğŸ‘¨â€ğŸ’¼ UI çº¿ç¨‹: å¼€å§‹ç‚¹é¤");
            await moveWorker(workerUI, 120, 200, 500);

            // 2. é‡åˆ° await
            log("âš¡ é‡åˆ° await! UI çº¿ç¨‹: 'å¨æˆ¿ä½ å…ˆåšï¼Œæˆ‘å»å¿™åˆ«çš„'");
            
            // UI çº¿ç¨‹â€œé£â€å›å»å¤„ç†å…¶ä»–äº‹æƒ…ï¼ˆå“åº”é¼ æ ‡ã€é‡ç»˜ç•Œé¢ï¼‰
            const originalPos = workerUI.style.left;
            workerUI.style.opacity = "0.5"; // è™šåŒ–è¡¨ç¤ºé‡Šæ”¾æ§åˆ¶æƒ
            workerUI.innerText = "ğŸ‘»";
            log("âœ¨ UI çº¿ç¨‹å·²é‡Šæ”¾ï¼Œç•Œé¢ä¿æŒæµç•…å“åº”...");
            
            // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ (åœ¨åå°/IO)
            const kitchenTask = document.createElement('div');
            kitchenTask.className = 'task-block';
            kitchenTask.style.left = '200px';
            kitchenTask.style.width = '0px';
            kitchenTask.style.top = '10px';
            kitchenTask.style.background = '#ffaa00';
            kitchenTask.innerText = "åšé¥­ä¸­...";
            document.querySelectorAll('.thread-track')[1].appendChild(kitchenTask); // Add to kitchen track

            // å¨æˆ¿å¹²æ´» (åŠ¨ç”»)
            const startTime = performance.now();
            while (performance.now() - startTime < 2000) {
                const width = (performance.now() - startTime) / 2000 * 200;
                kitchenTask.style.width = `${width}px`;
                await sleep(16);
            }
            
            // 3. await ç»“æŸï¼Œæ¢å¤ä¸Šä¸‹æ–‡
            log("ğŸ”” å®ï¼é¥­å¥½äº† (Task å®Œæˆ)");
            kitchenTask.remove();
            
            workerUI.style.opacity = "1";
            workerUI.innerText = "ğŸ‘¨â€ğŸ’¼";
            log("ğŸ”™ UI çº¿ç¨‹: 'æˆ‘å›æ¥äº†ï¼Œç»§ç»­æ‰§è¡Œ await åé¢çš„ä»£ç '");
            
            // ç»§ç»­æ‰§è¡Œ
            await moveWorker(workerUI, 200, 300, 500);
            log("ğŸ½ï¸ UI çº¿ç¨‹: å–é¤ï¼Œå¼€åƒï¼");

            workerUI.style.left = "120px"; // Reset
            log("--- ç»“æŸ ---");
            isRunning = false;
        });
    </script>
</body>
</html>

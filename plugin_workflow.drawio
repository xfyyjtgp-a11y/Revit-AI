<mxGraphModel>
  <root>
    <mxCell id="0"/>
    <mxCell id="1" parent="0"/>
    
    <!-- Group: Main Flow -->
    <mxCell id="2" value="启动插件命令&#xa;(Command.cs)" style="rounded=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontStyle=1" vertex="1" parent="1">
      <mxGeometry x="340" y="40" width="120" height="60" as="geometry"/>
    </mxCell>

    <mxCell id="3" value="检查 API Key" style="rhombus;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
      <mxGeometry x="340" y="140" width="120" height="80" as="geometry"/>
    </mxCell>

    <mxCell id="4" value="显示错误并退出" style="rounded=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
      <mxGeometry x="540" y="150" width="120" height="60" as="geometry"/>
    </mxCell>

    <mxCell id="5" value="显示输入窗口&#xa;(InputWindow)" style="rounded=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
      <mxGeometry x="340" y="260" width="120" height="60" as="geometry"/>
    </mxCell>

    <mxCell id="6" value="用户输入指令" style="shape=parallelogram;perimeter=parallelogramPerimeter;fixedSize=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="1">
      <mxGeometry x="330" y="360" width="140" height="60" as="geometry"/>
    </mxCell>

    <!-- Isolation Runner Group -->
    <mxCell id="group_iso" value="隔离环境执行 (IsolatedRunner.cs)" style="swimlane;fillColor=#f5f5f5;strokeColor=#666666;fontStyle=1;startSize=30;" vertex="1" parent="1">
      <mxGeometry x="100" y="460" width="600" height="700" as="geometry"/>
    </mxCell>

    <mxCell id="iso_1" value="创建 PluginLoadContext&#xa;(isCollectible = true)" style="rounded=1;fillColor=#ffe6cc;strokeColor=#d79b00;" vertex="1" parent="group_iso">
      <mxGeometry x="200" y="50" width="200" height="50" as="geometry"/>
    </mxCell>

    <mxCell id="iso_2" value="加载 RevitAI.dll 到隔离上下文&#xa;(context.LoadFromAssemblyPath)" style="rounded=1;fillColor=#ffe6cc;strokeColor=#d79b00;" vertex="1" parent="group_iso">
      <mxGeometry x="180" y="130" width="240" height="50" as="geometry"/>
    </mxCell>

    <mxCell id="iso_3" value="反射获取 AIService 类型&#xa;(isolatedAssembly.GetType)" style="rounded=1;fillColor=#ffe6cc;strokeColor=#d79b00;" vertex="1" parent="group_iso">
      <mxGeometry x="200" y="210" width="200" height="50" as="geometry"/>
    </mxCell>

    <mxCell id="iso_4" value="反射创建 AIService 实例&#xa;(Activator.CreateInstance)" style="rounded=1;fillColor=#ffe6cc;strokeColor=#d79b00;" vertex="1" parent="group_iso">
      <mxGeometry x="200" y="290" width="200" height="50" as="geometry"/>
    </mxCell>

    <mxCell id="iso_5" value="反射调用 ParseWallRequestJsonAsync&#xa;(method.Invoke)" style="rounded=1;fillColor=#ffe6cc;strokeColor=#d79b00;" vertex="1" parent="group_iso">
      <mxGeometry x="180" y="370" width="240" height="50" as="geometry"/>
    </mxCell>

    <!-- Inner AI Logic (Nested Group) -->
    <mxCell id="group_ai_inner" value="AI 核心逻辑 (AIService.cs)" style="swimlane;fillColor=#ffffff;strokeColor=#000000;dashed=1;" vertex="1" parent="group_iso">
      <mxGeometry x="120" y="450" width="360" height="150" as="geometry"/>
    </mxCell>
    
    <mxCell id="ai_1" value="构建 Prompt (System + User)" style="rounded=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="group_ai_inner">
      <mxGeometry x="80" y="30" width="200" height="40" as="geometry"/>
    </mxCell>
    
    <mxCell id="ai_2" value="调用 Semantic Kernel (LLM)" style="rounded=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="group_ai_inner">
      <mxGeometry x="80" y="90" width="200" height="40" as="geometry"/>
    </mxCell>
    
    <mxCell id="edge_ai_1_2" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" edge="1" parent="group_ai_inner" source="ai_1" target="ai_2">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <mxCell id="iso_6" value="卸载上下文 (context.Unload)&#xa;释放依赖文件锁定" style="rounded=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="group_iso">
      <mxGeometry x="200" y="630" width="200" height="50" as="geometry"/>
    </mxCell>

    <!-- Edges inside Isolation Group -->
    <mxCell id="edge_iso_1_2" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" edge="1" parent="group_iso" source="iso_1" target="iso_2">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="edge_iso_2_3" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" edge="1" parent="group_iso" source="iso_2" target="iso_3">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="edge_iso_3_4" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" edge="1" parent="group_iso" source="iso_3" target="iso_4">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="edge_iso_4_5" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" edge="1" parent="group_iso" source="iso_4" target="iso_5">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="edge_iso_5_ai" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" edge="1" parent="group_iso" source="iso_5" target="group_ai_inner">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="edge_ai_iso6" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" edge="1" parent="group_iso" source="group_ai_inner" target="iso_6">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

    <!-- Main Flow Continuation -->
    <mxCell id="8" value="解析 JSON 结果&#xa;(Main Context)" style="rhombus;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
      <mxGeometry x="340" y="1200" width="120" height="80" as="geometry"/>
    </mxCell>

    <mxCell id="9" value="显示错误并退出" style="rounded=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
      <mxGeometry x="540" y="1210" width="120" height="60" as="geometry"/>
    </mxCell>

    <mxCell id="10" value="开启 Revit 事务" style="rounded=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
      <mxGeometry x="320" y="1320" width="160" height="60" as="geometry"/>
    </mxCell>

    <mxCell id="11" value="创建墙体元素&#xa;(RevitModelCreator)" style="rounded=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
      <mxGeometry x="320" y="1420" width="160" height="60" as="geometry"/>
    </mxCell>

    <mxCell id="12" value="显示成功对话框" style="rounded=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
      <mxGeometry x="340" y="1520" width="120" height="60" as="geometry"/>
    </mxCell>

    <mxCell id="13" value="结束" style="ellipse;whiteSpace=wrap;html=1;aspect=fixed;fillColor=#f5f5f5;strokeColor=#666666;" vertex="1" parent="1">
      <mxGeometry x="380" y="1620" width="40" height="40" as="geometry"/>
    </mxCell>

    <!-- Edges Main -->
    <mxCell id="14" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" edge="1" parent="1" source="2" target="3">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="15" value="无效" style="endArrow=classic;html=1;exitX=1;exitY=0.5;entryX=0;entryY=0.5;" edge="1" parent="1" source="3" target="4">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="16" value="有效" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" edge="1" parent="1" source="3" target="5">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="17" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" edge="1" parent="1" source="5" target="6">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="18" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" edge="1" parent="1" source="6" target="iso_1">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="19" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" edge="1" parent="1" source="iso_6" target="8">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="20" value="失败" style="endArrow=classic;html=1;exitX=1;exitY=0.5;entryX=0;entryY=0.5;" edge="1" parent="1" source="8" target="9">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="21" value="成功" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" edge="1" parent="1" source="8" target="10">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="22" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" edge="1" parent="1" source="10" target="11">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="23" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" edge="1" parent="1" source="11" target="12">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>
    <mxCell id="24" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" edge="1" parent="1" source="12" target="13">
      <mxGeometry relative="1" as="geometry"/>
    </mxCell>

  </root>
</mxGraphModel>